<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>We Love Grace</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: url("/images/grace_background.jpg");
            background-size: cover;
            background-position: center;
            font-family: Arial, sans-serif;
        }

        .container {
            text-align: center;
            width: 90%;
            max-width: 800px;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }

        .message {
            margin-top: 30px;
            font-size: 36px;
            color: white;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .counter {
            margin-top: 15px;
            font-size: 18px;
            color: white;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 5px;
            display: inline-block;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* ç™»å½•å’Œç•™è¨€æ¿æ ·å¼ */
        .login-form, .message-board {
            margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: left;
        }

        .login-form {
            display: block;
        }

        .message-board {
            display: none;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }

        .comment {
            background-color: rgba(255, 255, 255, 0.8);
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #b19cd9;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .comment-content {
            margin-bottom: 10px;
        }

        .comment-media img, .comment-media video {
            max-width: 100%;
            max-height: 300px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .media-buttons {
            margin: 10px 0;
        }

        .emoji-picker {
            display: none;
            margin: 10px 0;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .emoji {
            font-size: 24px;
            cursor: pointer;
            margin: 5px;
        }

        .user-info {
            color: white;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 5px;
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="user-info" id="userInfo"></div>
    
    <div class="container">
        <button id="loveButton">ç‚¹å‡»è¿™é‡Œ</button>
        <div id="counter" class="counter">å·²æœ‰ 0 äººè¡¨è¾¾çˆ±æ„</div>
        <div id="loveMessage" class="message">We Love Grace! â¤ï¸</div>
        
        <!-- ç™»å½•è¡¨å• -->
        <div id="loginForm" class="login-form">
            <h2>æ¬¢è¿æ¥åˆ° Grace çš„ç•™è¨€æ¿</h2>
            <p>è¯·å…ˆè¾“å…¥æ‚¨çš„ç”¨æˆ·å</p>
            <input type="text" id="username" placeholder="ç”¨æˆ·å" required>
            <button id="loginButton">ç™»å½•</button>
        </div>
        
        <!-- ç•™è¨€æ¿ -->
        <div id="messageBoard" class="message-board">
            <h2>Grace çš„ç•™è¨€æ¿</h2>
            <div>
                <textarea id="commentText" placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..."></textarea>
                
                <div class="media-buttons">
                    <button id="emojiButton">æ·»åŠ è¡¨æƒ…</button>
                    <input type="file" id="mediaInput" accept="image/*,video/*" style="display:none">
                    <button id="mediaButton">æ·»åŠ å›¾ç‰‡/è§†é¢‘</button>
                </div>
                
                <div id="emojiPicker" class="emoji-picker">
                    <span class="emoji">ğŸ˜Š</span>
                    <span class="emoji">â¤ï¸</span>
                    <span class="emoji">ğŸ‘</span>
                    <span class="emoji">ğŸ‰</span>
                    <span class="emoji">ğŸŒ¹</span>
                    <span class="emoji">ğŸ¥°</span>
                    <span class="emoji">ğŸ˜</span>
                    <span class="emoji">ğŸ¤—</span>
                    <span class="emoji">ğŸŸ</span>
                </div>
                
                <div id="mediaPreview"></div>
                <button id="postButton">å‘å¸ƒç•™è¨€</button>
            </div>
            
            <div id="commentsContainer">
                <!-- ç•™è¨€å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script>
        // API URL
        const API_URL = '/api';

        // DOM å…ƒç´ 
        const loveButton = document.getElementById('loveButton');
        const counter = document.getElementById('counter');
        const loveMessage = document.getElementById('loveMessage');
        const loginForm = document.getElementById('loginForm');
        const messageBoard = document.getElementById('messageBoard');
        const userInfo = document.getElementById('userInfo');
        const loginButton = document.getElementById('loginButton');
        const username = document.getElementById('username');
        const commentText = document.getElementById('commentText');
        const postButton = document.getElementById('postButton');
        const commentsContainer = document.getElementById('commentsContainer');
        const emojiButton = document.getElementById('emojiButton');
        const emojiPicker = document.getElementById('emojiPicker');
        const mediaButton = document.getElementById('mediaButton');
        const mediaInput = document.getElementById('mediaInput');
        const mediaPreview = document.getElementById('mediaPreview');

        let currentUser = localStorage.getItem('graceUsername');
        let selectedFile = null;

        // é¡µé¢åŠ è½½æ—¶è·å–çˆ±å¿ƒè®¡æ•°
        async function getLoveCount() {
            try {
                const response = await fetch(`${API_URL}/love/count`);
                const data = await response.json();
                counter.textContent = `å·²æœ‰ ${data.count} äººè¡¨è¾¾çˆ±æ„`;
            } catch (error) {
                console.error('è·å–çˆ±å¿ƒè®¡æ•°å¤±è´¥:', error);
            }
        }

        // å¢åŠ çˆ±å¿ƒè®¡æ•°
        async function incrementLoveCount() {
            try {
                const response = await fetch(`${API_URL}/love/increment`, {
                    method: 'POST'
                });
                const data = await response.json();
                counter.textContent = `å·²æœ‰ ${data.count} äººè¡¨è¾¾çˆ±æ„`;
            } catch (error) {
                console.error('å¢åŠ çˆ±å¿ƒè®¡æ•°å¤±è´¥:', error);
            }
        }

        // çˆ±å¿ƒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        loveButton.addEventListener('click', function() {    
            if (loveMessage.style.display !== 'block') {
                incrementLoveCount();
            }
            
            if (loveMessage.style.display === 'block') {
                loveMessage.style.display = 'none';
            } else {
                loveMessage.style.display = 'block';
            }
        });

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        if (currentUser) {
            loginForm.style.display = 'none';
            messageBoard.style.display = 'block';
            userInfo.style.display = 'block';
            userInfo.textContent = `æ¬¢è¿, ${currentUser} | ç‚¹å‡»é€€å‡º`;
            loadComments();
        }

        // ç™»å½•åŠŸèƒ½
        loginButton.addEventListener('click', function() {
            if (username.value.trim() !== '') {
                currentUser = username.value.trim();
                localStorage.setItem('graceUsername', currentUser);
                loginForm.style.display = 'none';
                messageBoard.style.display = 'block';
                userInfo.style.display = 'block';
                userInfo.textContent = `æ¬¢è¿, ${currentUser} | ç‚¹å‡»é€€å‡º`;
                loadComments();
            } else {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
            }
        });

        // é€€å‡ºç™»å½•
        userInfo.addEventListener('click', function() {
            localStorage.removeItem('graceUsername');
            currentUser = null;
            loginForm.style.display = 'block';
            messageBoard.style.display = 'none';
            userInfo.style.display = 'none';
            username.value = '';
        });

        // è¡¨æƒ…é€‰æ‹©å™¨
        emojiButton.addEventListener('click', function() {
            emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
        });

        // æ·»åŠ è¡¨æƒ…
        document.querySelectorAll('.emoji').forEach(emoji => {
            emoji.addEventListener('click', function() {
                commentText.value += this.textContent;
                emojiPicker.style.display = 'none';
            });
        });

        // æ·»åŠ åª’ä½“
        mediaButton.addEventListener('click', function() {
            mediaInput.click();
        });

        mediaInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // æ–‡ä»¶å¤§å°é™åˆ¶
                if (file.type.startsWith('image/') && file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }
                
                if (file.type.startsWith('video/') && file.size > 20 * 1024 * 1024) {
                    alert('è§†é¢‘å¤§å°ä¸èƒ½è¶…è¿‡20MB');
                    return;
                }
                
                selectedFile = file;
                
                // é¢„è§ˆåª’ä½“
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (file.type.startsWith('image/')) {
                        mediaPreview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:200px">`;
                    } else if (file.type.startsWith('video/')) {
                        mediaPreview.innerHTML = `<video controls style="max-width:100%;max-height:200px"><source src="${e.target.result}"></video>`;
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // å‘å¸ƒç•™è¨€
        postButton.addEventListener('click', async function() {
            if (!commentText.value.trim() && !selectedFile) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹æˆ–æ·»åŠ åª’ä½“æ–‡ä»¶');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('username', currentUser);
                formData.append('content', commentText.value.trim());
                
                if (selectedFile) {
                    formData.append('media', selectedFile);
                }
                
                const response = await fetch(`${API_URL}/comments`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // é‡ç½®è¾“å…¥åŒºåŸŸ
                    commentText.value = '';
                    selectedFile = null;
                    mediaPreview.innerHTML = '';
                    
                    // é‡æ–°åŠ è½½ç•™è¨€
                    await loadComments();
                } else {
                    alert('å‘å¸ƒç•™è¨€å¤±è´¥');
                }
            } catch (error) {
                console.error('å‘å¸ƒç•™è¨€å¤±è´¥:', error);
                alert('å‘å¸ƒç•™è¨€å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // åŠ è½½ç•™è¨€
        async function loadComments() {
            try {
                const response = await fetch(`${API_URL}/comments`);
                const comments = await response.json();
                
                commentsContainer.innerHTML = '';
                
                comments.forEach(comment => {
                    const date = new Date(comment.timestamp);
                    const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    let mediaElement = '';
                    if (comment.mediaUrl) {
                        if (comment.mediaType === 'image') {
                            mediaElement = `<div class="comment-media"><img src="${comment.mediaUrl}" alt="ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡"></div>`;
                        } else if (comment.mediaType === 'video') {
                            mediaElement = `<div class="comment-media"><video controls><source src="${comment.mediaUrl}"></video></div>`;
                        }
                    }
                    
                    const commentElement = document.createElement('div');
                    commentElement.className = 'comment';
                    commentElement.innerHTML = `
                        <div class="comment-header">
                            <span>${comment.username}</span>
                            <span>${formattedDate}</span>
                        </div>
                        <div class="comment-content">${comment.content}</div>
                        ${mediaElement}
                    `;
                    
                    commentsContainer.appendChild(commentElement);
                });
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–çˆ±å¿ƒè®¡æ•°
        getLoveCount();
    </script>
</body>
</html>
{
  "name": "we-love-grace",
  "version": "1.0.0",
  "description": "Grace çš„åŠ¨æ€ç½‘ç«™",
  "main": "server/server.js",
  "scripts": {
    "start": "node server/server.js",
    "dev": "nodemon server/server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "dependencies": {
    "body-parser": "^1.19.0",
    "cors": "^2.8.5",
    "dotenv": "^10.0.0",
    "express": "^4.17.1",
    "mongoose": "^6.0.12",
    "multer": "^1.4.3"
  },
  "devDependencies": {
    "nodemon": "^2.0.14"
  }
}